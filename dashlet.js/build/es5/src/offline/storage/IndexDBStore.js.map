{"version":3,"sources":["../../../../../src/offline/storage/IndexDBStore.js"],"names":["localforage","require","entities","XmlEntities","IndexDBStore","instance","manifestStore","fragmentStores","setup","window","config","driver","INDEXEDDB","name","createInstance","version","storeName","createFragmentStore","console","log","fragmentStore","setDownloadingStatus","manifestId","newStatus","getManifestById","then","item","status","updateManifest","catch","Promise","reject","err","setRepresentationCurrentState","representationId","state","index","downloaded","getRepresentationCurrentState","resolve","getFragmentByKey","key","Error","getItem","value","id","getAllManifests","array","i","manifests","length","parseInt","manifest","decode","getCurrentHigherManifestId","higherManifestId","setItem","saveSelectedRepresentations","selected","storeManifest","results","push","storeFragment","fragmentId","fragmentData","dropAll","clear","dropFragmentStore","dropInstance","deleteDownloadById","deleteFragmentStore","splice","__dashjs_factory_name","dashjs","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"IndexDBStore.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nconst localforage = require('localforage');\nconst entities = require('html-entities').XmlEntities;\n\n/**\n * @ignore\n */\nfunction IndexDBStore() {\n\n    let instance,\n        manifestStore,\n        fragmentStores;\n\n    function setup() {\n        fragmentStores = {};\n\n        if (typeof window === 'undefined') {\n            return;\n        }\n\n        localforage.config({\n            driver: localforage.INDEXEDDB,\n            name: 'dash_offline_db'\n        });\n\n        manifestStore = localforage.createInstance({\n            driver: localforage.INDEXEDDB,\n            name: 'dash_offline_db',\n            version: 1.0,\n            storeName: 'manifest'\n        });\n    }\n\n    /////////////////////////////////////////\n    //\n    // GET/SET Methods\n    //\n    ////////////////////////////////////////\n\n    /**\n     * Creates an instance of localforage to store fragments in indexed db\n     * @param {string} storeName\n     * @instance\n     */\n    function createFragmentStore(storeName) {\n\n        if (!fragmentStores[storeName]) {\n            console.log('setStore  ' + storeName);\n            let fragmentStore = localforage.createInstance({\n                driver: localforage.INDEXEDDB,\n                name: 'dash_offline_db',\n                version: 1.0,\n                storeName: storeName\n            });\n            fragmentStores[storeName] = fragmentStore;\n        }\n    }\n\n    /**\n     * Update download status\n     * @param {number} manifestId\n     * @param {string} newStatus\n     * @returns {Promise} promise\n     * @instance\n     */\n    function setDownloadingStatus(manifestId, newStatus) {\n        return getManifestById(manifestId).then(function (item) {\n            item.status = newStatus;\n            return updateManifest(item).catch(function () {\n                return Promise.reject('Cannot set status ' + newStatus + ' for this stream !');\n            });\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Updat last downloaded fragment index for representationId\n     * @param {number} manifestId - manifest id\n      * @param {string} representationId - representation\n     * @param {number} state - representation state\n     * @returns {Promise} promise\n     * @instance\n     */\n    function setRepresentationCurrentState(manifestId, representationId, state) {\n        return getManifestById(manifestId).then(function (item) {\n            if (!item.state) {\n                item.state = {};\n            }\n\n            if (!item.state[representationId]) {\n                item.state[representationId] = {\n                    index: -1,\n                    downloaded: 0\n                };\n            }\n\n            item.state[representationId] = state;\n            return updateManifest(item).catch(function () {\n                return Promise.reject('Cannot set current index for represenation id ' + representationId);\n            });\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Returns current downloaded segment index for representation\n     * @param {number} manifestId - manifest id\n     * @param {string} representationId - representation\n     * @returns {Promise} promise\n     * @instance\n     */\n    function getRepresentationCurrentState(manifestId, representationId) {\n        return getManifestById(manifestId).then(function (item) {\n            let state = {\n                index: -1,\n                downloaded: 0\n            };\n            if (item.state && item.state[representationId]) {\n                state = item.state[representationId];\n            }\n            return Promise.resolve(state);\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Returns a fragment from its key\n     * @param {number} manifestId\n     * @param {number} key\n     * @returns {Promise} fragment\n     * @instance\n     */\n    function getFragmentByKey(manifestId, key) {\n        let fragmentStore = fragmentStores[manifestId];\n\n        if (!fragmentStore) {\n            return Promise.reject(new Error (`No fragment store found for manifest ${manifestId}`));\n        }\n\n        return fragmentStore.getItem(key).then(function (value) {\n            return Promise.resolve(value);\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n\n    }\n\n    /**\n     * Returns a manifest from its identifier\n     * @param {number} id\n     * @returns {Promise} {Object[]} manifests\n     * @instance\n     */\n    function getManifestById(id) {\n        return getAllManifests().then(function (array) {\n            if (array) {\n                let item = null;\n                for (let i = 0; i < array.manifests.length; i++) {\n                    if (array.manifests[i].manifestId === parseInt(id)) {\n                        item = array.manifests[i];\n                    }\n                }\n                if (item !== null) {\n                    item.manifest = entities.decode(item.manifest);\n                    return Promise.resolve(item);\n                } else {\n                    return Promise.reject('Cannot found manifest with this manifestId : ' + id);\n                }\n            } else {\n                return Promise.reject('Any manifests stored in DB !');\n            }\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Returns all offline manifests\n     * @returns {Promise} {Object[]} manifests\n     * @instance\n     */\n    function getAllManifests() {\n        return manifestStore.getItem('manifest').then(function (array) {\n            return Promise.resolve(array ? array : {\n                'manifests': []\n            });\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Return higher manifest id\n     * @returns {Promise} number\n     * @instance\n     */\n    function getCurrentHigherManifestId() {\n        return getAllManifests().then(function (array) {\n            let higherManifestId = 0;\n            if (array) {\n                for (let i = 0; i < array.manifests.length; i++) {\n                    if (array.manifests[i].manifestId > higherManifestId) {\n                        higherManifestId = array.manifests[i].manifestId;\n                    }\n                }\n                return Promise.resolve(higherManifestId);\n            } else {\n                return Promise.resolve(higherManifestId);\n            }\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Update manifest\n     * @param {Object} manifest updated manifest\n     * @returns {Promise} promise asynchronously resolved\n     * @instance\n     */\n    function updateManifest(manifest) {\n        return getAllManifests().then(function (array) {\n            try {\n                for (let i = 0; i < array.manifests.length; i++) {\n                    if (array.manifests[i].manifestId === manifest.manifestId) {\n                        array.manifests[i] = manifest;\n                    }\n                }\n                return manifestStore.setItem('manifest', array);\n            } catch (err) {\n                throw new Error('Any results found !');\n            }\n        });\n    }\n\n    /**\n     * save selected representation by user\n     * @param {Object} manifest updated manifest\n     * @param {Object} selected selected representations\n     * @returns {Promise} promise asynchronously resolved\n     * @instance\n     */\n    function saveSelectedRepresentations(manifest, selected) {\n        return getManifestById(manifest).then(function (item) {\n            if (!item.selected) {\n                item.selected = {};\n            }\n\n            item.selected = selected;\n            return updateManifest(item).catch(function () {\n                return Promise.reject('Cannot save selected representations');\n            });\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Store a manifest in manifest array\n     * @param {Object} manifest\n     * @instance\n     */\n    function storeManifest(manifest) {\n        return manifestStore.getItem('manifest').then(function (results) {\n            let array = results ? results : {\n                'manifests': []\n            };\n            array.manifests.push(manifest);\n            return manifestStore.setItem('manifest', array);\n        });\n    }\n\n    /**\n     * Store a fragment in fragment store\n     * @param {number} manifestId\n     * @param {number} fragmentId\n     * @param {Object} fragmentData\n     * @returns {Promise} promise asynchronously resolved\n     * @instance\n     */\n    function storeFragment(manifestId, fragmentId, fragmentData) {\n        let fragmentStore = fragmentStores[manifestId];\n\n        if (!fragmentStore) {\n            return Promise.reject(new Error (`No fragment store found for manifest ${manifestId}`));\n        }\n\n        return fragmentStore.setItem(fragmentId, fragmentData, function () {\n            return Promise.resolve();\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /////////////////////////////////////////\n    //\n    // DROP Methods\n    //\n    ////////////////////////////////////////\n\n    /**\n     * Remove all manifest and fragment store\n     * @returns {Promise} promise asynchronously resolved\n     * @instance\n     */\n    function dropAll() {\n        return localforage.clear().then(function () {\n            return Promise.resolve();\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Remove framgent store given its name\n     * @param {string} storeName\n     * @instance\n     */\n    function dropFragmentStore(storeName) {\n        localforage.dropInstance({\n            driver: localforage.INDEXEDDB,\n            name: 'dash_offline_db',\n            version: 1.0,\n            storeName: storeName\n        }).then(function () {\n            delete fragmentStores[storeName];\n        }).catch(function (err) {\n            console.log('dropFragmentStore failed ' + err);\n        });\n        return;\n    }\n\n    /**\n     * Remove download given its id (fragmentStore + manifest entry in manifest array)\n     * @param {number} manifestId\n     * @returns {Promise} promise asynchronously resolved\n     * @instance\n     */\n    function deleteDownloadById(manifestId) {\n        return manifestStore.getItem('manifest').then(function (array) {\n            if (array) {\n                return deleteFragmentStore(manifestId).then(function () {\n                    for (let i = 0; i < array.manifests.length; i++) {\n                        if (array.manifests[i].manifestId === parseInt(manifestId)) {\n                            array.manifests.splice(i, 1);\n                        }\n                    }\n                    return manifestStore.setItem('manifest', array).then(function () {\n                        return Promise.resolve('This stream has been successfull removed !');\n                    }).catch(function () {\n                        return Promise.reject('An error occured when trying to delete this manifest');\n                    });\n                });\n            } else {\n                return Promise.resolve('Nothing to delete !');\n            }\n        }).catch(function (err) {\n            return Promise.reject(err);\n        });\n    }\n\n    /**\n     * Remove fragment store\n     * @param {string} storeName\n     * @returns {Promise} promise asynchronously resolved\n     * @instance\n     */\n    function deleteFragmentStore(storeName) {\n        localforage.createInstance({\n            name: 'dash_offline_db',\n            storeName: storeName\n        });\n        return localforage.dropInstance({\n            name: 'dash_offline_db',\n            storeName: storeName\n        }).then(function () {\n            delete fragmentStores[storeName];\n            return Promise.resolve();\n        }).catch(function (err) {\n            console.log(err);\n            return Promise.reject(err);\n        });\n\n    }\n\n\n    setup();\n\n    instance = {\n        dropAll: dropAll,\n        getFragmentByKey: getFragmentByKey,\n        getManifestById: getManifestById,\n        storeFragment: storeFragment,\n        storeManifest: storeManifest,\n        updateManifest: updateManifest,\n        saveSelectedRepresentations: saveSelectedRepresentations,\n        createFragmentStore: createFragmentStore,\n        setDownloadingStatus: setDownloadingStatus,\n        setRepresentationCurrentState: setRepresentationCurrentState,\n        getRepresentationCurrentState: getRepresentationCurrentState,\n        getCurrentHigherManifestId: getCurrentHigherManifestId,\n        getAllManifests: getAllManifests,\n        dropFragmentStore: dropFragmentStore,\n        deleteDownloadById: deleteDownloadById\n    };\n\n    return instance;\n}\n\nIndexDBStore.__dashjs_factory_name = 'IndexDBStore';\nexport default dashjs.FactoryMaker.getSingletonFactory(IndexDBStore); /* jshint ignore:line */\n"]}