{"version":3,"sources":["../../../../../src/streaming/controllers/FragmentController.js"],"names":["FragmentController","config","context","eventBus","getInstance","errHandler","mediaPlayerModel","dashMetrics","debug","instance","logger","fragmentModels","streamId","setup","getLogger","resetInitialSettings","on","Events","FRAGMENT_LOADING_COMPLETED","onFragmentLoadingCompleted","FRAGMENT_LOADING_PROGRESS","getModel","type","model","create","fragmentLoader","requestModifier","settings","boxParser","events","errors","Errors","dashConstants","urlUtils","reset","off","createDataChunk","bytes","request","endFragment","chunk","DataChunk","mediaInfo","segmentType","start","startTime","duration","end","index","quality","representationId","e","sender","response","isInit","isInitializationRequest","streamInfo","id","error","mediaType","Constants","AUDIO","VIDEO","FRAGMENTED_TEXT","trigger","SERVICE_LOCATION_BLACKLIST_ADD","entry","serviceLocation","warn","INIT_FRAGMENT_LOADED","MEDIA_FRAGMENT_LOADED","setStreamId","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"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","file":"FragmentController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport Constants from '../constants/Constants';\nimport DataChunk from '../vo/DataChunk';\nimport FragmentModel from '../models/FragmentModel';\nimport FragmentLoader from '../FragmentLoader';\nimport RequestModifier from '../utils/RequestModifier';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport Errors from '../../core/errors/Errors';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\n\nfunction FragmentController( config ) {\n\n    config = config || {};\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n\n    const errHandler = config.errHandler;\n    const mediaPlayerModel = config.mediaPlayerModel;\n    const dashMetrics = config.dashMetrics;\n    const debug = Debug(context).getInstance();\n\n    let instance,\n        logger,\n        fragmentModels,\n        streamId;\n\n    function setup() {\n        logger = debug.getLogger(instance);\n        resetInitialSettings();\n        eventBus.on(Events.FRAGMENT_LOADING_COMPLETED, onFragmentLoadingCompleted, instance);\n        eventBus.on(Events.FRAGMENT_LOADING_PROGRESS, onFragmentLoadingCompleted, instance);\n    }\n\n    function getModel(streamId, type) {\n        let model = fragmentModels[type];\n        if (!model) {\n            model = FragmentModel(context).create({\n                streamId: streamId,\n                dashMetrics: dashMetrics,\n                fragmentLoader: FragmentLoader(context).create({\n                    dashMetrics: dashMetrics,\n                    mediaPlayerModel: mediaPlayerModel,\n                    errHandler: errHandler,\n                    requestModifier: RequestModifier(context).getInstance(),\n                    settings: config.settings,\n                    boxParser: config.boxParser,\n                    eventBus: eventBus,\n                    events: Events,\n                    errors: Errors,\n                    dashConstants: config.dashConstants,\n                    urlUtils: config.urlUtils\n                }),\n                debug: debug,\n                eventBus: eventBus,\n                events: Events\n            });\n\n            fragmentModels[type] = model;\n        }\n\n        return model;\n    }\n\n    function resetInitialSettings() {\n        for (let model in fragmentModels) {\n            fragmentModels[model].reset();\n        }\n        fragmentModels = {};\n    }\n\n    function reset() {\n        eventBus.off(Events.FRAGMENT_LOADING_COMPLETED, onFragmentLoadingCompleted, this);\n        eventBus.off(Events.FRAGMENT_LOADING_PROGRESS, onFragmentLoadingCompleted, this);\n        resetInitialSettings();\n    }\n\n    function createDataChunk(bytes, request, streamId, endFragment) {\n        const chunk = new DataChunk();\n\n        chunk.streamId = streamId;\n        chunk.mediaInfo = request.mediaInfo;\n        chunk.segmentType = request.type;\n        chunk.start = request.startTime;\n        chunk.duration = request.duration;\n        chunk.end = chunk.start + chunk.duration;\n        chunk.bytes = bytes;\n        chunk.index = request.index;\n        chunk.quality = request.quality;\n        chunk.representationId = request.representationId;\n        chunk.endFragment = endFragment;\n\n        return chunk;\n    }\n\n    function onFragmentLoadingCompleted(e) {\n        // Event propagation may have been stopped (see MssHandler)\n        if (!e.sender) return;\n\n        const request = e.request;\n        const bytes = e.response;\n        const isInit = request.isInitializationRequest();\n        const streamInfo = request.mediaInfo.streamInfo;\n\n        if (streamInfo && streamInfo.id !== streamId) return;\n\n        if (e.error) {\n            if (e.request.mediaType === Constants.AUDIO || e.request.mediaType === Constants.VIDEO || e.request.mediaType === Constants.FRAGMENTED_TEXT) {\n                // add service location to blacklist controller - only for audio or video. text should not set errors\n                eventBus.trigger(Events.SERVICE_LOCATION_BLACKLIST_ADD, {entry: e.request.serviceLocation});\n            }\n        }\n\n        if (!bytes || !streamInfo) {\n            logger.warn('No ' + request.mediaType + ' bytes to push or stream is inactive.');\n            return;\n        }\n        const chunk = createDataChunk(bytes, request, streamInfo.id, e.type !== Events.FRAGMENT_LOADING_PROGRESS);\n        eventBus.trigger(isInit ? Events.INIT_FRAGMENT_LOADED : Events.MEDIA_FRAGMENT_LOADED, {\n            chunk: chunk,\n            request: request\n        });\n    }\n\n    function setStreamId (id) {\n        streamId = id;\n    }\n\n    instance = {\n        getModel: getModel,\n        setStreamId: setStreamId,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\nFragmentController.__dashjs_factory_name = 'FragmentController';\nexport default FactoryMaker.getClassFactory(FragmentController);\n"]}