{"version":3,"sources":["../../../../../src/streaming/models/MediaPlayerModel.js"],"names":["DEFAULT_MIN_BUFFER_TIME","DEFAULT_MIN_BUFFER_TIME_FAST_SWITCH","DEFAULT_LOW_LATENCY_LIVE_DELAY","LOW_LATENCY_REDUCTION_FACTOR","LOW_LATENCY_MULTIPLY_FACTOR","DEFAULT_LIVE_LATENCY_CATCHUP_THRESHOLD_FACTOR","DEFAULT_XHR_WITH_CREDENTIALS","MediaPlayerModel","instance","UTCTimingSources","xhrWithCredentials","customABRRule","DEFAULT_UTC_TIMING_SOURCE","scheme","value","context","settings","getInstance","setup","default","findABRCustomRuleIndex","rulename","i","length","getABRCustomRules","addABRCustomRule","type","rule","ABRRulesCollection","ABANDON_FRAGMENT_RULES","QUALITY_SWITCH_RULES","Constants","BAD_ARGUMENT_ERROR","index","push","removeABRCustomRule","splice","getStableBufferTime","get","streaming","lowLatencyEnabled","getLiveDelay","stableBufferTime","fastSwitchEnabled","getRetryAttemptsForType","lowLatencyMultiplyFactor","isNaN","retryAttempts","getRetryIntervalsForType","lowLatencyReductionFactor","retryIntervals","liveDelay","getLiveCatchupLatencyThreshold","liveCatchupLatencyThreshold","Math","max","liveCatchupMinDrift","liveCatchUpMinDrift","maximumLiveDelay","NaN","e","addUTCTimingSource","schemeIdUri","removeUTCTimingSource","vo","UTCTiming","getUTCTimingSources","forEach","obj","idx","clearDefaultUTCTimingSources","restoreDefaultUTCTimingSources","setXHRWithCredentialsForType","Object","keys","key","getXHRWithCredentialsForType","useCreds","undefined","getDefaultUtcTimingSource","reset","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"sEA8BA,kD,mDACA,qD,yDACA,iD,mDACA,mE,qEACA,6C,iDACA,yD,mFAnCA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAsCA,GAAMA,yBAA0B,EAAhC,CACA,GAAMC,qCAAsC,EAA5C,CAEA,GAAMC,gCAAiC,GAAvC,CACA,GAAMC,8BAA+B,EAArC,CACA,GAAMC,6BAA8B,CAApC,CACA,GAAMC,+CAAgD,CAAtD,CAEA,GAAMC,8BAA+B,KAArC,CAEA,QAASC,iBAAT,EAA4B,CAExB,GAAIC,gBAAJ,CACIC,uBADJ,CAEIC,yBAFJ,CAGIC,oBAHJ,CAKA,GAAMC,2BAA4B,CAC9BC,OAAQ,oCADsB,CAE9BC,MAAO,gCAFuB,CAAlC,CAIA,GAAMC,SAAU,KAAKA,OAArB,CACA,GAAMC,UAAW,uBAASD,OAAT,EAAkBE,WAAlB,EAAjB,CAEA,QAASC,MAAT,EAAiB,CACbT,iBAAmB,EAAnB,CACAC,mBAAqB,CACjBS,QAASb,4BADQ,CAArB,CAGAK,cAAgB,EAAhB,CACH,CAED;AACA,QAASS,uBAAT,CAAgCC,QAAhC,CAA0C,CACtC,GAAIC,SAAJ,CACA,IAAKA,EAAI,CAAT,CAAYA,EAAIX,cAAcY,MAA9B,CAAsCD,GAAtC,CAA2C,CACvC,GAAIX,cAAcW,CAAd,EAAiBD,QAAjB,GAA8BA,QAAlC,CAA4C,CACxC,MAAOC,EAAP,CACH,CACJ,CACD,MAAO,CAAC,CAAR,CACH,CAED,QAASE,kBAAT,EAA6B,CACzB,MAAOb,cAAP,CACH,CAED,QAASc,iBAAT,CAA0BC,IAA1B,CAAgCL,QAAhC,CAA0CM,IAA1C,CAAgD,CAC5C,GAAI,MAAOD,KAAP,GAAgB,QAAhB,EAA6BA,OAASE,6BAAmBC,sBAA5B,EAAsDH,OAASE,6BAAmBE,oBAA/G,EACA,MAAOT,SAAP,GAAoB,QADxB,CACkC,CAC9B,KAAMU,qBAAUC,kBAAhB,CACH,CACD,GAAIC,OAAQb,uBAAuBC,QAAvB,CAAZ,CACA,GAAIY,QAAU,CAAC,CAAf,CAAkB,CACd;AACAtB,cAAcuB,IAAd,CAAmB,CACfR,KAAMA,IADS,CAEfL,SAAUA,QAFK,CAGfM,KAAMA,IAHS,CAAnB,EAKH,CAPD,IAOO,CACH;AACAhB,cAAcsB,KAAd,EAAqBP,IAArB,CAA4BA,IAA5B,CACAf,cAAcsB,KAAd,EAAqBN,IAArB,CAA4BA,IAA5B,CACH,CACJ,CAED,QAASQ,oBAAT,CAA6Bd,QAA7B,CAAuC,CACnC,GAAIA,QAAJ,CAAc,CACV,GAAIY,OAAQb,uBAAuBC,QAAvB,CAAZ,CACA;AACA,GAAIY,QAAU,CAAC,CAAf,CAAkB,CACd;AACAtB,cAAcyB,MAAd,CAAqBH,KAArB,CAA4B,CAA5B,EACH,CACJ,CAPD,IAOO,CACH;AACAtB,cAAgB,EAAhB,CACH,CACJ,CAED,QAAS0B,oBAAT,EAA+B,CAC3B,GAAIrB,SAASsB,GAAT,GAAeC,SAAf,CAAyBC,iBAA7B,CAAgD,CAC5C,MAAOC,gBAAiB,GAAxB,CACH,CAED,GAAMC,kBAAmB1B,SAASsB,GAAT,GAAeC,SAAf,CAAyBG,gBAAlD,CACA,MAAOA,kBAAmB,CAAC,CAApB,CAAwBA,gBAAxB,CAA2C1B,SAASsB,GAAT,GAAeC,SAAf,CAAyBI,iBAAzB,CAA6C1C,mCAA7C,CAAmFD,uBAArI,CACH,CAED,QAAS4C,wBAAT,CAAiClB,IAAjC,CAAuC,CACnC,GAAMmB,0BAA2B,CAACC,MAAM9B,SAASsB,GAAT,GAAeC,SAAf,CAAyBQ,aAAzB,CAAuCF,wBAA7C,CAAD,CAA0E7B,SAASsB,GAAT,GAAeC,SAAf,CAAyBQ,aAAzB,CAAuCF,wBAAjH,CAA4IzC,2BAA7K,CAEA,MAAOY,UAASsB,GAAT,GAAeC,SAAf,CAAyBC,iBAAzB,CAA6CxB,SAASsB,GAAT,GAAeC,SAAf,CAAyBQ,aAAzB,CAAuCrB,IAAvC,EAA+CmB,wBAA5F,CAAuH7B,SAASsB,GAAT,GAAeC,SAAf,CAAyBQ,aAAzB,CAAuCrB,IAAvC,CAA9H,CACH,CAED,QAASsB,yBAAT,CAAkCtB,IAAlC,CAAwC,CACpC,GAAMuB,2BAA4B,CAACH,MAAM9B,SAASsB,GAAT,GAAeC,SAAf,CAAyBW,cAAzB,CAAwCD,yBAA9C,CAAD,CAA4EjC,SAASsB,GAAT,GAAeC,SAAf,CAAyBW,cAAzB,CAAwCD,yBAApH,CAAgJ9C,4BAAlL,CAEA,MAAOa,UAASsB,GAAT,GAAeC,SAAf,CAAyBC,iBAAzB,CAA6CxB,SAASsB,GAAT,GAAeC,SAAf,CAAyBW,cAAzB,CAAwCxB,IAAxC,EAAgDuB,yBAA7F,CAAyHjC,SAASsB,GAAT,GAAeC,SAAf,CAAyBW,cAAzB,CAAwCxB,IAAxC,CAAhI,CACH,CAED,QAASe,aAAT,EAAwB,CACpB,GAAIzB,SAASsB,GAAT,GAAeC,SAAf,CAAyBC,iBAA7B,CAAgD,CAC5C,MAAOxB,UAASsB,GAAT,GAAeC,SAAf,CAAyBY,SAAzB,EAAsCjD,8BAA7C,CACH,CACD,MAAOc,UAASsB,GAAT,GAAeC,SAAf,CAAyBY,SAAhC,CACH,CAED,QAASC,+BAAT,EAA0C,CACtC,GAAI,CACA,GAAMC,6BAA8BrC,SAASsB,GAAT,GAAeC,SAAf,CAAyBc,2BAA7D,CACA,GAAMF,WAAYV,cAAlB,CAEA,GAAIY,8BAAgC,IAAhC,EAAwC,CAACP,MAAMO,2BAAN,CAA7C,CAAiF,CAC7E,MAAOC,MAAKC,GAAL,CAASF,2BAAT,CAAsCF,SAAtC,CAAP,CACH,CAGD,GAAMK,qBAAsBxC,SAASsB,GAAT,GAAeC,SAAf,CAAyBkB,mBAArD,CACA,GAAMC,kBAAmB,CAACZ,MAAMK,SAAN,CAAD,EAAqBA,SAArB,CAAiC,CAACL,MAAMU,mBAAN,CAAD,CAA8BxC,SAASsB,GAAT,GAAeC,SAAf,CAAyBkB,mBAAzB,CAA+ChB,cAA7E,CAA8FA,cAA/H,CAAgJkB,GAAzK,CAEA,GAAID,kBAAoB,CAACZ,MAAMY,gBAAN,CAAzB,CAAkD,CAC9C,MAAOA,kBAAmBrD,6CAA1B,CACH,CAED,MAAOsD,IAAP,CAEH,CAAC,MAAOC,CAAP,CAAU,CACR,MAAOD,IAAP,CACH,CACJ,CAED,QAASE,mBAAT,CAA4BC,WAA5B,CAAyChD,KAAzC,CAAgD,CAC5CiD,sBAAsBD,WAAtB,CAAmChD,KAAnC,EAA2C;AAC3C,GAAIkD,IAAK,GAAIC,oBAAJ,EAAT,CACAD,GAAGF,WAAH,CAAiBA,WAAjB,CACAE,GAAGlD,KAAH,CAAWA,KAAX,CACAL,iBAAiByB,IAAjB,CAAsB8B,EAAtB,EACH,CAED,QAASE,oBAAT,EAA+B,CAC3B,MAAOzD,iBAAP,CACH,CAED,QAASsD,sBAAT,CAA+BD,WAA/B,CAA4ChD,KAA5C,CAAmD,CAC/C,wCAAmBgD,WAAnB,CAAgC,QAAhC,EACA,wCAAmBhD,KAAnB,CAA0B,QAA1B,EACAL,iBAAiB0D,OAAjB,CAAyB,SAAUC,GAAV,CAAeC,GAAf,CAAoB,CACzC,GAAID,IAAIN,WAAJ,GAAoBA,WAApB,EAAmCM,IAAItD,KAAJ,GAAcA,KAArD,CAA4D,CACxDL,iBAAiB2B,MAAjB,CAAwBiC,GAAxB,CAA6B,CAA7B,EACH,CACJ,CAJD,EAKH,CAED,QAASC,6BAAT,EAAwC,CACpC7D,iBAAmB,EAAnB,CACH,CAED,QAAS8D,+BAAT,EAA0C,CACtCV,mBAAmBjD,0BAA0BC,MAA7C,CAAqDD,0BAA0BE,KAA/E,EACH,CAED,QAAS0D,6BAAT,CAAsC9C,IAAtC,CAA4CZ,KAA5C,CAAmD,CAC/C,GAAI,CAACY,IAAL,CAAW,CACP+C,OAAOC,IAAP,CAAYhE,kBAAZ,EAAgCyD,OAAhC,CAAwC,aAAO,CAC3CK,6BAA6BG,GAA7B,CAAkC7D,KAAlC,EACH,CAFD,EAGH,CAJD,IAIO,CACHJ,mBAAmBgB,IAAnB,EAA2B,CAAC,CAACZ,KAA7B,CACH,CACJ,CAED,QAAS8D,6BAAT,CAAsClD,IAAtC,CAA4C,CACxC,GAAMmD,UAAWnE,mBAAmBgB,IAAnB,CAAjB,CAEA,MAAOmD,YAAaC,SAAb,CAAyBpE,mBAAmBS,OAA5C,CAAsD0D,QAA7D,CACH,CAED,QAASE,0BAAT,EAAqC,CACjC,MAAOnE,0BAAP,CACH,CAED,QAASoE,MAAT,EAAiB,CACb;AACA;AACH,CAEDxE,SAAW,CACPgB,mCADO,CAEPC,iCAFO,CAGPU,uCAHO,CAIPE,uCAJO,CAKPO,+CALO,CAMPI,iDANO,CAOPP,yBAPO,CAQPW,6DARO,CASPS,qCATO,CAUPE,2CAVO,CAWPG,uCAXO,CAYPI,yDAZO,CAaPC,6DAbO,CAcPC,yDAdO,CAePI,yDAfO,CAgBPG,mDAhBO,CAiBPC,WAjBO,CAAX,CAoBA9D,QAEA,MAAOV,SAAP,CACH,CAED;AACAD,iBAAiB0E,qBAAjB,CAAyC,kBAAzC,C,gBACeC,uBAAaC,mBAAb,CAAiC5E,gBAAjC,C","file":"MediaPlayerModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport UTCTiming from '../../dash/vo/UTCTiming';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Constants from '../constants/Constants';\nimport ABRRulesCollection from '../rules/abr/ABRRulesCollection';\nimport Settings from '../../core/Settings';\nimport {checkParameterType} from '../utils/SupervisorTools';\n\n\nconst DEFAULT_MIN_BUFFER_TIME = 12;\nconst DEFAULT_MIN_BUFFER_TIME_FAST_SWITCH = 20;\n\nconst DEFAULT_LOW_LATENCY_LIVE_DELAY = 3.0;\nconst LOW_LATENCY_REDUCTION_FACTOR = 10;\nconst LOW_LATENCY_MULTIPLY_FACTOR = 5;\nconst DEFAULT_LIVE_LATENCY_CATCHUP_THRESHOLD_FACTOR = 2;\n\nconst DEFAULT_XHR_WITH_CREDENTIALS = false;\n\nfunction MediaPlayerModel() {\n\n    let instance,\n        UTCTimingSources,\n        xhrWithCredentials,\n        customABRRule;\n\n    const DEFAULT_UTC_TIMING_SOURCE = {\n        scheme: 'urn:mpeg:dash:utc:http-xsdate:2014',\n        value: 'http://time.akamai.com/?iso&ms'\n    };\n    const context = this.context;\n    const settings = Settings(context).getInstance();\n\n    function setup() {\n        UTCTimingSources = [];\n        xhrWithCredentials = {\n            default: DEFAULT_XHR_WITH_CREDENTIALS\n        };\n        customABRRule = [];\n    }\n\n    //TODO Should we use Object.define to have setters/getters? makes more readable code on other side.\n    function findABRCustomRuleIndex(rulename) {\n        let i;\n        for (i = 0; i < customABRRule.length; i++) {\n            if (customABRRule[i].rulename === rulename) {\n                return i;\n            }\n        }\n        return -1;\n    }\n\n    function getABRCustomRules() {\n        return customABRRule;\n    }\n\n    function addABRCustomRule(type, rulename, rule) {\n        if (typeof type !== 'string' || (type !== ABRRulesCollection.ABANDON_FRAGMENT_RULES && type !== ABRRulesCollection.QUALITY_SWITCH_RULES) ||\n            typeof rulename !== 'string') {\n            throw Constants.BAD_ARGUMENT_ERROR;\n        }\n        let index = findABRCustomRuleIndex(rulename);\n        if (index === -1) {\n            // add rule\n            customABRRule.push({\n                type: type,\n                rulename: rulename,\n                rule: rule\n            });\n        } else {\n            // update rule\n            customABRRule[index].type = type;\n            customABRRule[index].rule = rule;\n        }\n    }\n\n    function removeABRCustomRule(rulename) {\n        if (rulename) {\n            let index = findABRCustomRuleIndex(rulename);\n            //if no rulename custom rule has been found, do nothing\n            if (index !== -1) {\n                // remove rule\n                customABRRule.splice(index, 1);\n            }\n        } else {\n            //if no rulename is defined, remove all ABR custome rules\n            customABRRule = [];\n        }\n    }\n\n    function getStableBufferTime() {\n        if (settings.get().streaming.lowLatencyEnabled) {\n            return getLiveDelay() * 0.6;\n        }\n\n        const stableBufferTime = settings.get().streaming.stableBufferTime;\n        return stableBufferTime > -1 ? stableBufferTime : settings.get().streaming.fastSwitchEnabled ? DEFAULT_MIN_BUFFER_TIME_FAST_SWITCH : DEFAULT_MIN_BUFFER_TIME;\n    }\n\n    function getRetryAttemptsForType(type) {\n        const lowLatencyMultiplyFactor = !isNaN(settings.get().streaming.retryAttempts.lowLatencyMultiplyFactor) ? settings.get().streaming.retryAttempts.lowLatencyMultiplyFactor : LOW_LATENCY_MULTIPLY_FACTOR;\n\n        return settings.get().streaming.lowLatencyEnabled ? settings.get().streaming.retryAttempts[type] * lowLatencyMultiplyFactor : settings.get().streaming.retryAttempts[type];\n    }\n\n    function getRetryIntervalsForType(type) {\n        const lowLatencyReductionFactor = !isNaN(settings.get().streaming.retryIntervals.lowLatencyReductionFactor) ? settings.get().streaming.retryIntervals.lowLatencyReductionFactor : LOW_LATENCY_REDUCTION_FACTOR;\n\n        return settings.get().streaming.lowLatencyEnabled ? settings.get().streaming.retryIntervals[type] / lowLatencyReductionFactor : settings.get().streaming.retryIntervals[type];\n    }\n\n    function getLiveDelay() {\n        if (settings.get().streaming.lowLatencyEnabled) {\n            return settings.get().streaming.liveDelay || DEFAULT_LOW_LATENCY_LIVE_DELAY;\n        }\n        return settings.get().streaming.liveDelay;\n    }\n\n    function getLiveCatchupLatencyThreshold() {\n        try {\n            const liveCatchupLatencyThreshold = settings.get().streaming.liveCatchupLatencyThreshold;\n            const liveDelay = getLiveDelay();\n\n            if (liveCatchupLatencyThreshold !== null && !isNaN(liveCatchupLatencyThreshold)) {\n                return Math.max(liveCatchupLatencyThreshold, liveDelay);\n            }\n\n\n            const liveCatchupMinDrift = settings.get().streaming.liveCatchUpMinDrift;\n            const maximumLiveDelay = !isNaN(liveDelay) && liveDelay ? !isNaN(liveCatchupMinDrift) ? settings.get().streaming.liveCatchUpMinDrift + getLiveDelay() : getLiveDelay() : NaN;\n\n            if (maximumLiveDelay && !isNaN(maximumLiveDelay)) {\n                return maximumLiveDelay * DEFAULT_LIVE_LATENCY_CATCHUP_THRESHOLD_FACTOR;\n            }\n\n            return NaN;\n\n        } catch (e) {\n            return NaN;\n        }\n    }\n\n    function addUTCTimingSource(schemeIdUri, value) {\n        removeUTCTimingSource(schemeIdUri, value); //check if it already exists and remove if so.\n        let vo = new UTCTiming();\n        vo.schemeIdUri = schemeIdUri;\n        vo.value = value;\n        UTCTimingSources.push(vo);\n    }\n\n    function getUTCTimingSources() {\n        return UTCTimingSources;\n    }\n\n    function removeUTCTimingSource(schemeIdUri, value) {\n        checkParameterType(schemeIdUri, 'string');\n        checkParameterType(value, 'string');\n        UTCTimingSources.forEach(function (obj, idx) {\n            if (obj.schemeIdUri === schemeIdUri && obj.value === value) {\n                UTCTimingSources.splice(idx, 1);\n            }\n        });\n    }\n\n    function clearDefaultUTCTimingSources() {\n        UTCTimingSources = [];\n    }\n\n    function restoreDefaultUTCTimingSources() {\n        addUTCTimingSource(DEFAULT_UTC_TIMING_SOURCE.scheme, DEFAULT_UTC_TIMING_SOURCE.value);\n    }\n\n    function setXHRWithCredentialsForType(type, value) {\n        if (!type) {\n            Object.keys(xhrWithCredentials).forEach(key => {\n                setXHRWithCredentialsForType(key, value);\n            });\n        } else {\n            xhrWithCredentials[type] = !!value;\n        }\n    }\n\n    function getXHRWithCredentialsForType(type) {\n        const useCreds = xhrWithCredentials[type];\n\n        return useCreds === undefined ? xhrWithCredentials.default : useCreds;\n    }\n\n    function getDefaultUtcTimingSource() {\n        return DEFAULT_UTC_TIMING_SOURCE;\n    }\n\n    function reset() {\n        //TODO need to figure out what props to persist across sessions and which to reset if any.\n        //setup();\n    }\n\n    instance = {\n        getABRCustomRules,\n        addABRCustomRule,\n        removeABRCustomRule,\n        getStableBufferTime,\n        getRetryAttemptsForType,\n        getRetryIntervalsForType,\n        getLiveDelay,\n        getLiveCatchupLatencyThreshold,\n        addUTCTimingSource,\n        removeUTCTimingSource,\n        getUTCTimingSources,\n        clearDefaultUTCTimingSources,\n        restoreDefaultUTCTimingSources,\n        setXHRWithCredentialsForType,\n        getXHRWithCredentialsForType,\n        getDefaultUtcTimingSource,\n        reset\n    };\n\n    setup();\n\n    return instance;\n}\n\n//TODO see if you can move this and not export and just getter to get default value.\nMediaPlayerModel.__dashjs_factory_name = 'MediaPlayerModel';\nexport default FactoryMaker.getSingletonFactory(MediaPlayerModel);\n"]}